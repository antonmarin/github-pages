---
version: "2"

tasks:
  lint:
    cmds:
      - docker run --rm -tv ${PWD}:/app hadolint/hadolint:v1.8.0
        hadolint
        /app/alpine/Dockerfile
        /app/debian/Dockerfile

  test:
    deps: [lint]
    cmds:
      - docker build alpine/ --build-arg GEM_VERSION={{ .GEM_VERSION }}
      - docker build debian/ --build-arg GEM_VERSION={{ .GEM_VERSION }}

  release:
    cmds:
      - task: test
        vars:
          GEM_VERSION:
            sh: echo {{ .GEM_VERSION }}
      - docker run --rm -it -v $PWD:/app -w /app busybox sed
        -i"" "s/^ARG\ GEM_VERSION=.*/ARG\ GEM_VERSION={{ .GEM_VERSION }}/" */Dockerfile
      -
